{% extends "base.html" %}

{% block title %}{{ series.title }} - Season {{ season_number }}{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/series/{{ series.id }}/seasons" style="color: #4CAF50; text-decoration: none;">&larr; Back to Seasons</a>
</div>

<div style="display: flex; align-items: flex-start; gap: 30px; margin-bottom: 40px;">
    {% if series.poster_url %}
    <img src="{{ series.poster_url }}" alt="{{ series.title }}"
         style="width: 150px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);"
         onerror="this.style.display='none'"/>
    {% endif %}

    <div>
        <h1 style="margin: 0 0 10px 0;">{{ series.title }}</h1>
        <h2 style="margin: 0 0 10px 0; color: #999;">Season {{ season_number }}</h2>
        <p style="color: #ccc;">Click "Search Webshare" to find downloads for an episode</p>
    </div>
</div>

<div id="loading" style="display: block; text-align: center; padding: 40px;">
    <p>Loading episodes...</p>
</div>

<div id="episodes-list" style="display: none;"></div>

<div id="no-episodes" style="display: none;" class="empty-state">
    <h3>No missing episodes</h3>
    <p>All episodes for this season are downloaded!</p>
</div>

<!-- Search Results Modal -->
<div id="search-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modal-title">Search Results</h2>
        <div id="modal-loading" style="text-align: center; padding: 40px;">
            <p>Searching Webshare...</p>
        </div>
        <div id="modal-results"></div>
    </div>
</div>

<style>
.episode-card {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
    position: relative;
}

.episode-card:hover {
    background: #252525;
}

.episode-card.downloaded {
    background: #1a3a1a;
    border-left: 4px solid #4CAF50;
}

.episode-card.downloaded:hover {
    background: #1f4a1f;
}

.episode-info {
    flex: 1;
}

.episode-number {
    font-size: 14px;
    color: #4CAF50;
    font-weight: bold;
    margin-bottom: 5px;
}

.episode-title {
    font-size: 16px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
}

.episode-date {
    font-size: 12px;
    color: #999;
}

.btn {
    padding: 10px 20px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.btn:hover {
    background: #45a049;
}

.btn:disabled {
    background: #666;
    cursor: not-allowed;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #888;
}

.empty-state h3 {
    margin-bottom: 10px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.7);
}

.modal-content {
    background-color: #1a1a1a;
    margin: 5% auto;
    padding: 30px;
    border: 1px solid #333;
    border-radius: 8px;
    width: 90%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #fff;
}

.result-card {
    background: #252525;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.result-title {
    font-size: 14px;
    color: #fff;
    margin-bottom: 10px;
    word-break: break-word;
}

.result-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.badge-quality {
    background: #2196F3;
    color: white;
}

.badge-czech {
    background: #FF5722;
    color: white;
}

.badge-lang {
    background: #9C27B0;
    color: white;
}

.badge-size {
    background: #607D8B;
    color: white;
}

.badge-score {
    background: #4CAF50;
    color: white;
}

.badge-downloaded {
    background: #4CAF50;
    color: white;
    position: absolute;
    top: 20px;
    right: 20px;
}
</style>

<script>
const seriesId = {{ series.id }};
const seriesTitle = "{{ series.title }}";
const seriesPath = "{{ series.path }}";
const seasonNumber = {{ season_number }};

let currentEpisode = null;
let currentPendingId = null;
let downloadedEpisodes = new Set(); // Set of "S01E01" strings

async function loadDownloadStatus() {
    try {
        const response = await fetch(`/api/download-status?source=sonarr&series_id=${seriesId}&season=${seasonNumber}`);
        const data = await response.json();

        if (data.success) {
            downloadedEpisodes.clear();
            data.downloaded.forEach(item => {
                downloadedEpisodes.add(item.identifier); // e.g., "S01E01"
            });
        }
    } catch (error) {
        console.error('Error loading download status:', error);
    }
}

async function loadEpisodes() {
    const loading = document.getElementById('loading');
    const episodesList = document.getElementById('episodes-list');
    const noEpisodes = document.getElementById('no-episodes');

    try {
        // First load download status
        await loadDownloadStatus();

        // Then load episodes
        const response = await fetch(`/api/series/${seriesId}/season/${seasonNumber}`);
        const data = await response.json();

        loading.style.display = 'none';

        if (data.success && data.episodes.length > 0) {
            episodesList.style.display = 'block';
            renderEpisodes(data.episodes);
        } else {
            noEpisodes.style.display = 'block';
        }
    } catch (error) {
        loading.style.display = 'none';
        alert(`Error loading episodes: ${error.message}`);
    }
}

function renderEpisodes(episodes) {
    const episodesList = document.getElementById('episodes-list');
    episodesList.innerHTML = '';

    // Sort episodes: downloaded ones go to the end
    const sortedEpisodes = [...episodes].sort((a, b) => {
        const aId = `S${String(a.season_number).padStart(2, '0')}E${String(a.episode_number).padStart(2, '0')}`;
        const bId = `S${String(b.season_number).padStart(2, '0')}E${String(b.episode_number).padStart(2, '0')}`;
        const aDownloaded = downloadedEpisodes.has(aId);
        const bDownloaded = downloadedEpisodes.has(bId);

        if (aDownloaded && !bDownloaded) return 1;
        if (!aDownloaded && bDownloaded) return -1;
        return a.episode_number - b.episode_number;
    });

    sortedEpisodes.forEach(episode => {
        const episodeId = `S${String(episode.season_number).padStart(2, '0')}E${String(episode.episode_number).padStart(2, '0')}`;
        const isDownloaded = downloadedEpisodes.has(episodeId);

        const card = document.createElement('div');
        card.className = 'episode-card' + (isDownloaded ? ' downloaded' : '');
        card.dataset.episodeId = episodeId;

        card.innerHTML = `
            <div class="episode-info">
                <div class="episode-number">${episodeId}</div>
                <div class="episode-title">${episode.title || 'Unknown Title'}</div>
                <div class="episode-date">${episode.air_date || 'Air date unknown'}</div>
            </div>
            ${isDownloaded
                ? '<span class="badge badge-downloaded">Odesláno</span>'
                : `<button class="btn" onclick="searchEpisode(${episode.season_number}, ${episode.episode_number}, '${(episode.title || '').replace(/'/g, "\\'")}')">Search Webshare</button>`
            }
        `;

        episodesList.appendChild(card);
    });
}

async function searchEpisode(season, episode, episodeTitle) {
    currentEpisode = {season, episode, episodeTitle};

    // Show modal
    const modal = document.getElementById('search-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalLoading = document.getElementById('modal-loading');
    const modalResults = document.getElementById('modal-results');

    modalTitle.textContent = `${seriesTitle} - S${String(season).padStart(2, '0')}E${String(episode).padStart(2, '0')}`;
    modalLoading.style.display = 'block';
    modalResults.innerHTML = '';
    modal.style.display = 'block';

    try {
        const response = await fetch('/api/search-episode', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                series_id: seriesId,
                series_title: seriesTitle,
                series_path: seriesPath,
                season: season,
                episode: episode
            })
        });

        const data = await response.json();
        modalLoading.style.display = 'none';

        if (data.success && data.results_count > 0) {
            currentPendingId = data.pending_id;
            renderResults(data.results, data.pending_id);
        } else {
            modalResults.innerHTML = '<p style="text-align: center; color: #999;">No results found on Webshare.</p>';
        }
    } catch (error) {
        modalLoading.style.display = 'none';
        modalResults.innerHTML = `<p style="text-align: center; color: #f44336;">Error: ${error.message}</p>`;
    }
}

function renderResults(results, pendingId) {
    const modalResults = document.getElementById('modal-results');
    modalResults.innerHTML = '';

    results.forEach((result, index) => {
        const card = document.createElement('div');
        card.className = 'result-card';

        const parsed = result.parsed || {};
        const score = result.score || {};

        card.innerHTML = `
            <div class="result-title">${result.name}</div>
            <div class="result-meta">
                ${parsed.quality ? `<span class="badge badge-quality">${parsed.quality}</span>` : ''}
                ${parsed.has_czech ? `<span class="badge badge-czech">CZ</span>` : ''}
                ${parsed.language ? `<span class="badge badge-lang">${parsed.language}</span>` : ''}
                ${parsed.source ? `<span class="badge badge-lang">${parsed.source}</span>` : ''}
                ${result.file_size_gb ? `<span class="badge badge-size">${result.file_size_gb.toFixed(2)} GB</span>` : ''}
                ${score.total !== undefined ? `<span class="badge badge-score">Score: ${score.total}</span>` : ''}
            </div>
            <button class="btn" onclick="downloadFile(${pendingId}, ${index})">Download This</button>
        `;

        modalResults.appendChild(card);
    });
}

async function downloadFile(pendingId, resultIndex) {
    try {
        // Disable all buttons
        document.querySelectorAll('.modal .btn').forEach(btn => {
            btn.disabled = true;
            btn.textContent = 'Odesílám...';
        });

        const response = await fetch('/api/confirm', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pending_id: pendingId,
                result_index: resultIndex
            })
        });

        const data = await response.json();

        if (data.success) {
            // Close modal
            document.getElementById('search-modal').style.display = 'none';

            // Mark episode as downloaded
            const episodeId = `S${String(currentEpisode.season).padStart(2, '0')}E${String(currentEpisode.episode).padStart(2, '0')}`;
            downloadedEpisodes.add(episodeId);

            // Show success message
            alert(`✓ Odesláno do pyLoad (Package ID: ${data.package_id})`);

            // Reload episodes to update UI
            await loadEpisodes();

            // Handle navigation based on response
            if (data.navigation) {
                const nav = data.navigation;
                if (nav.next_action === 'go_to_seasons') {
                    setTimeout(() => {
                        window.location.href = `/series/${seriesId}/seasons`;
                    }, 1500);
                } else if (nav.next_action === 'go_to_series_list') {
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                }
                // If 'stay', remain on current page (already reloaded episodes)
            }
        } else {
            alert(`Chyba: ${data.error || 'Nepodařilo se odeslat'}`);
            // Re-enable buttons
            document.querySelectorAll('.modal .btn').forEach(btn => {
                btn.disabled = false;
                btn.textContent = 'Download This';
            });
        }
    } catch (error) {
        alert(`Chyba: ${error.message}`);
        // Re-enable buttons
        document.querySelectorAll('.modal .btn').forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'Download This';
        });
    }
}

// Modal close button
document.querySelector('.close').onclick = function() {
    document.getElementById('search-modal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('search-modal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Load episodes on page load
window.addEventListener('DOMContentLoaded', () => {
    loadEpisodes();
});
</script>
{% endblock %}
