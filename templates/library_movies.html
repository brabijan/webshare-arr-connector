{% extends "base.html" %}

{% block title %}Library - Movies{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <nav style="display: flex; gap: 10px; align-items: center; background: transparent; padding: 0;">
        <a href="/" style="color: #4a9eff; text-decoration: none;">Home</a>
        <span style="color: #666;">/</span>
        <a href="/library" style="color: #4a9eff; text-decoration: none;">Library</a>
        <span style="color: #666;">/</span>
        <span style="color: #fff;">Movies</span>
    </nav>
</div>

<h1 style="margin-bottom: 30px;">Movies in Library</h1>

<div id="loading" style="display: block; text-align: center; padding: 40px;">
    <p>Loading movies...</p>
</div>

<!-- Search & Filters for Movies -->
<div id="filters-section" class="filters-section" style="display: none;">
    <div class="filter-row">
        <input type="text" id="searchMovies" class="form-control" placeholder="Search by movie title...">
        <select id="filterResolution" class="form-control">
            <option value="">All Resolutions</option>
            <option value="2160p">2160p / 4K</option>
            <option value="1080p">1080p</option>
            <option value="720p">720p</option>
        </select>
        <select id="filterCzechAudio" class="form-control">
            <option value="">Any Audio</option>
            <option value="yes">Has Czech Audio</option>
            <option value="no">No Czech Audio</option>
        </select>
        <select id="filterCzechSubs" class="form-control">
            <option value="">Any Subtitles</option>
            <option value="yes">Has Czech Subs</option>
            <option value="no">No Czech Subs</option>
        </select>
        <select id="filterCodec" class="form-control">
            <option value="">Any Codec</option>
            <option value="H.264">H.264 / x264</option>
            <option value="HEVC">HEVC / H.265</option>
        </select>
    </div>
</div>

<div id="movies-table" style="display: none;">
    <table>
        <thead>
            <tr>
                <th>Movie Title</th>
                <th>Resolution</th>
                <th>Codec</th>
                <th>Audio</th>
                <th>Subtitles</th>
                <th>Source</th>
                <th>Size</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="movies-body">
        </tbody>
    </table>
</div>

<div id="no-movies" style="display: none;" class="empty-state">
    <h3>No Movies</h3>
    <p>There are no movies in the library yet.</p>
</div>

<!-- Search Results Modal -->
<div id="search-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modal-title">Find Better Version</h2>
        <div id="modal-loading" style="text-align: center; padding: 40px;">
            <p>Searching on Webshare...</p>
        </div>
        <div id="modal-results"></div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<style>
/* Filters Section */
.filters-section {
    margin-bottom: 25px;
}

.filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    gap: 12px;
    align-items: center;
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
    transition: all 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #4CAF50;
    background: #2f2f2f;
}

.form-control::placeholder {
    color: #666;
}

/* Upgrade Candidate Row Highlights */
tr.upgrade-candidate-no-czech-audio {
    background: rgba(244, 67, 54, 0.15) !important;
    border-left: 3px solid #f44336;
}

tr.upgrade-candidate-subs-only {
    background: rgba(255, 193, 7, 0.15) !important;
    border-left: 3px solid #FFC107;
}

tr.upgrade-candidate-low-res {
    background: rgba(33, 150, 243, 0.15) !important;
    border-left: 3px solid #2196F3;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: #2a2a2a;
    border-radius: 8px;
    overflow: hidden;
}

th {
    background: #1f1f1f;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
}

td {
    padding: 12px;
    border-top: 1px solid #3a3a3a;
    vertical-align: middle;
}

tr:hover {
    background: #252525;
}

.movie-title {
    font-weight: 600;
    color: #fff;
}

.movie-year {
    color: #999;
    font-size: 0.9em;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
    margin: 2px;
}

.badge-resolution {
    background: #2196F3;
    color: white;
}

.badge-codec {
    background: #4CAF50;
    color: white;
}

.badge-codec-hevc {
    background: #FFC107;
    color: #000;
}

.badge-audio {
    background: #9C27B0;
    color: white;
}

.badge-audio-missing-cs {
    background: #f44336;
    color: white;
}

.badge-subtitle {
    background: #607D8B;
    color: white;
}

.badge-subtitle-missing-cs {
    background: #f44336;
    color: white;
}

.badge-source {
    background: #795548;
    color: white;
}

.badge-size {
    background: #424242;
    color: #fff;
}

.btn-upgrade {
    padding: 8px 16px;
    background: #4a9eff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.2s;
    white-space: nowrap;
}

.btn-upgrade:hover {
    background: #6ab0ff;
}

.btn-upgrade:disabled {
    background: #666;
    cursor: not-allowed;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.7);
}

.modal-content {
    background-color: #1a1a1a;
    margin: 5% auto;
    padding: 30px;
    border: 1px solid #333;
    border-radius: 8px;
    width: 90%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #fff;
}

.result-card {
    background: #252525;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.result-title {
    font-size: 14px;
    color: #fff;
    margin-bottom: 10px;
    word-break: break-word;
}

.result-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
}

.badge-quality {
    background: #2196F3;
    color: white;
}

.badge-czech {
    background: #FF5722;
    color: white;
}

.badge-lang {
    background: #9C27B0;
    color: white;
}

.badge-score {
    background: #4CAF50;
    color: white;
}

/* Toast Notification */
.toast-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 2000;
}

.toast {
    background: #4CAF50;
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    margin-bottom: 10px;
    min-width: 300px;
    animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.toast.error {
    background: #f44336;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}
</style>

<script>
let currentMovie = null;
let allMovies = [];
let filteredMovies = [];

// Toast notification function
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'error' ? 'error' : ''}`;
    toast.textContent = message;

    container.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Format file size
function formatSize(bytes) {
    if (!bytes) return '-';
    const gb = bytes / (1024 * 1024 * 1024);
    return gb.toFixed(2) + ' GB';
}

// Load movies from API
async function loadMovies() {
    const loading = document.getElementById('loading');
    const moviesTable = document.getElementById('movies-table');
    const filtersSection = document.getElementById('filters-section');
    const noMovies = document.getElementById('no-movies');

    try {
        const response = await fetch('/api/library/movies');
        const data = await response.json();

        loading.style.display = 'none';

        if (data.success && data.movies && data.movies.length > 0) {
            allMovies = data.movies;
            filteredMovies = data.movies;
            moviesTable.style.display = 'block';
            filtersSection.style.display = 'block';
            renderMovies(data.movies);
        } else {
            noMovies.style.display = 'block';
        }
    } catch (error) {
        loading.style.display = 'none';
        showToast(`Error loading movies: ${error.message}`, 'error');
    }
}

// Check if movie needs upgrade
function getUpgradeClass(movie) {
    // Check for Czech audio
    const audioLangs = movie.audio_languages || [];
    const hasCzechAudio = audioLangs.some(lang =>
        lang && (lang.toLowerCase() === 'cs' || lang.toLowerCase() === 'cz' || lang.toLowerCase() === 'ces')
    );

    // Check for Czech subtitles
    const subLangs = movie.subtitle_languages || [];
    const hasCzechSubs = subLangs.some(lang =>
        lang && (lang.toLowerCase() === 'cs' || lang.toLowerCase() === 'cz' || lang.toLowerCase() === 'ces')
    );

    // Check resolution
    const resolution = movie.resolution || '';
    const resolutionValue = parseInt(resolution) || 0;

    // Priority: Missing CZ audio > Only CZ subs > Low resolution
    if (audioLangs.length > 0 && !hasCzechAudio) {
        return 'upgrade-candidate-no-czech-audio';
    }
    if (!hasCzechAudio && hasCzechSubs) {
        return 'upgrade-candidate-subs-only';
    }
    if (resolutionValue < 1080) {
        return 'upgrade-candidate-low-res';
    }

    return '';
}

// Filter movies
function filterMovies() {
    const searchText = document.getElementById('searchMovies').value.toLowerCase();
    const resolution = document.getElementById('filterResolution').value;
    const czechAudio = document.getElementById('filterCzechAudio').value;
    const czechSubs = document.getElementById('filterCzechSubs').value;
    const codec = document.getElementById('filterCodec').value;

    filteredMovies = allMovies.filter(movie => {
        // Search by title
        if (searchText && !movie.title.toLowerCase().includes(searchText)) {
            return false;
        }

        // Filter by resolution
        if (resolution && movie.resolution !== resolution) {
            return false;
        }

        // Filter by Czech audio
        if (czechAudio) {
            const audioLangs = movie.audio_languages || [];
            const hasCzech = audioLangs.some(lang =>
                lang && (lang.toLowerCase() === 'cs' || lang.toLowerCase() === 'cz' || lang.toLowerCase() === 'ces')
            );
            if (czechAudio === 'yes' && !hasCzech) return false;
            if (czechAudio === 'no' && hasCzech) return false;
        }

        // Filter by Czech subtitles
        if (czechSubs) {
            const subLangs = movie.subtitle_languages || [];
            const hasCzech = subLangs.some(lang =>
                lang && (lang.toLowerCase() === 'cs' || lang.toLowerCase() === 'cz' || lang.toLowerCase() === 'ces')
            );
            if (czechSubs === 'yes' && !hasCzech) return false;
            if (czechSubs === 'no' && hasCzech) return false;
        }

        // Filter by codec
        if (codec && movie.codec) {
            const metaCodec = movie.codec.toUpperCase();
            if (codec === 'H.264' && !metaCodec.includes('H.264') && !metaCodec.includes('X264')) {
                return false;
            }
            if (codec === 'HEVC' && !metaCodec.includes('HEVC') && !metaCodec.includes('H.265')) {
                return false;
            }
        }

        return true;
    });

    renderMovies(filteredMovies);
}

// Render movies table
function renderMovies(movies) {
    const tbody = document.getElementById('movies-body');
    tbody.innerHTML = '';

    movies.forEach(movie => {
        const tr = document.createElement('tr');
        tr.className = getUpgradeClass(movie);

        // Title cell with year
        const titleCell = document.createElement('td');
        titleCell.innerHTML = `
            <div class="movie-title">${movie.title}</div>
            ${movie.year ? `<div class="movie-year">(${movie.year})</div>` : ''}
        `;

        // Resolution cell
        const resolutionCell = document.createElement('td');
        if (movie.resolution) {
            resolutionCell.innerHTML = `<span class="badge badge-resolution">üé¨ ${movie.resolution}</span>`;
        } else {
            resolutionCell.textContent = '-';
        }

        // Codec cell
        const codecCell = document.createElement('td');
        if (movie.codec) {
            const isHEVC = movie.codec.toUpperCase().includes('HEVC') || movie.codec.toUpperCase().includes('H.265');
            const codecClass = isHEVC ? 'badge-codec-hevc' : 'badge-codec';
            const codecIcon = isHEVC ? '‚ö†Ô∏è' : 'üé•';
            codecCell.innerHTML = `<span class="badge ${codecClass}">${codecIcon} ${movie.codec}</span>`;
        } else {
            codecCell.textContent = '-';
        }

        // Audio cell
        const audioCell = document.createElement('td');
        if (movie.audio_languages && movie.audio_languages.length > 0) {
            const hasCs = movie.audio_languages.some(lang => lang.toLowerCase() === 'cs' || lang.toLowerCase() === 'cz');
            const audioClass = hasCs ? 'badge-audio' : 'badge-audio-missing-cs';
            audioCell.innerHTML = `<span class="badge ${audioClass}">üîä ${movie.audio_languages.join(', ')}</span>`;
        } else {
            audioCell.textContent = '-';
        }

        // Subtitles cell
        const subtitlesCell = document.createElement('td');
        if (movie.subtitle_languages && movie.subtitle_languages.length > 0) {
            const hasCs = movie.subtitle_languages.some(lang => lang.toLowerCase() === 'cs' || lang.toLowerCase() === 'cz');
            const subtitleClass = hasCs ? 'badge-subtitle' : 'badge-subtitle-missing-cs';
            subtitlesCell.innerHTML = `<span class="badge ${subtitleClass}">üìù ${movie.subtitle_languages.join(', ')}</span>`;
        } else {
            subtitlesCell.textContent = '-';
        }

        // Source cell
        const sourceCell = document.createElement('td');
        if (movie.source) {
            sourceCell.innerHTML = `<span class="badge badge-source">üì¶ ${movie.source}</span>`;
        } else {
            sourceCell.textContent = '-';
        }

        // Size cell
        const sizeCell = document.createElement('td');
        if (movie.size) {
            sizeCell.innerHTML = `<span class="badge badge-size">üíæ ${formatSize(movie.size)}</span>`;
        } else {
            sizeCell.textContent = '-';
        }

        // Action cell
        const actionCell = document.createElement('td');
        const upgradeBtn = document.createElement('button');
        upgradeBtn.className = 'btn-upgrade';
        upgradeBtn.textContent = 'Find Better Version';
        upgradeBtn.onclick = () => searchUpgrade(movie);
        actionCell.appendChild(upgradeBtn);

        tr.appendChild(titleCell);
        tr.appendChild(resolutionCell);
        tr.appendChild(codecCell);
        tr.appendChild(audioCell);
        tr.appendChild(subtitlesCell);
        tr.appendChild(sourceCell);
        tr.appendChild(sizeCell);
        tr.appendChild(actionCell);

        tbody.appendChild(tr);
    });
}

// Search for upgrade
async function searchUpgrade(movie) {
    currentMovie = movie;

    // Show modal
    const modal = document.getElementById('search-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalLoading = document.getElementById('modal-loading');
    const modalResults = document.getElementById('modal-results');

    modalTitle.textContent = `Find Better Version: ${movie.title}${movie.year ? ` (${movie.year})` : ''}`;
    modalLoading.style.display = 'block';
    modalResults.innerHTML = '';
    modal.style.display = 'block';

    try {
        const response = await fetch('/api/library/movies/upgrade', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                movie_id: movie.id,
                title: movie.title,
                year: movie.year
            })
        });

        const data = await response.json();
        modalLoading.style.display = 'none';

        if (data.success && data.results && data.results.length > 0) {
            renderResults(data.results, movie);
        } else {
            modalResults.innerHTML = '<p style="text-align: center; color: #999;">No results found on Webshare.</p>';
        }
    } catch (error) {
        modalLoading.style.display = 'none';
        modalResults.innerHTML = `<p style="text-align: center; color: #f44336;">Error: ${error.message}</p>`;
    }
}

// Render search results
function renderResults(results, movie) {
    const modalResults = document.getElementById('modal-results');
    modalResults.innerHTML = '';

    results.forEach((result, index) => {
        const card = document.createElement('div');
        card.className = 'result-card';

        const parsed = result.parsed || {};
        const score = result.score || {};

        card.innerHTML = `
            <div class="result-title">${result.name}</div>
            <div class="result-meta">
                ${parsed.quality ? `<span class="badge badge-quality">${parsed.quality}</span>` : ''}
                ${parsed.has_czech ? `<span class="badge badge-czech">CZ</span>` : ''}
                ${parsed.language ? `<span class="badge badge-lang">${parsed.language}</span>` : ''}
                ${parsed.source ? `<span class="badge badge-lang">${parsed.source}</span>` : ''}
                ${result.file_size_gb ? `<span class="badge badge-size">${result.file_size_gb.toFixed(2)} GB</span>` : ''}
                ${score.total !== undefined ? `<span class="badge badge-score">Score: ${score.total}</span>` : ''}
            </div>
            <button class="btn" onclick="downloadUpgrade(${index})">Download This Version</button>
        `;

        modalResults.appendChild(card);
    });
}

// Download upgrade
async function downloadUpgrade(resultIndex) {
    try {
        // Disable all buttons
        document.querySelectorAll('.modal .btn').forEach(btn => {
            btn.disabled = true;
            btn.textContent = 'Sending...';
        });

        const response = await fetch('/api/library/movies/download', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                movie_id: currentMovie.id,
                result_index: resultIndex
            })
        });

        const data = await response.json();

        if (data.success) {
            // Close modal
            document.getElementById('search-modal').style.display = 'none';

            // Show success message
            showToast(`Sent to pyLoad (Package ID: ${data.package_id})`);

            // Reload movies
            await loadMovies();
        } else {
            showToast(`Error: ${data.error || 'Failed to send'}`, 'error');
            // Re-enable buttons
            document.querySelectorAll('.modal .btn').forEach(btn => {
                btn.disabled = false;
                btn.textContent = 'Download This Version';
            });
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
        // Re-enable buttons
        document.querySelectorAll('.modal .btn').forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'Download This Version';
        });
    }
}

// Modal close button
document.querySelector('.close').onclick = function() {
    document.getElementById('search-modal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('search-modal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Load movies on page load
window.addEventListener('DOMContentLoaded', () => {
    loadMovies();

    // Attach filter event listeners
    document.getElementById('searchMovies').addEventListener('input', filterMovies);
    document.getElementById('filterResolution').addEventListener('change', filterMovies);
    document.getElementById('filterCzechAudio').addEventListener('change', filterMovies);
    document.getElementById('filterCzechSubs').addEventListener('change', filterMovies);
    document.getElementById('filterCodec').addEventListener('change', filterMovies);
});
</script>
{% endblock %}
