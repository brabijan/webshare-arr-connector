{% extends "base.html" %}

{% block title %}{{ movie.title }} - Movie Detail (Library){% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/library" style="color: #4CAF50; text-decoration: none;">&larr; Back to Library</a>
</div>

<div style="display: flex; align-items: flex-start; gap: 30px; margin-bottom: 40px;">
    {% if movie.poster_url %}
    <img src="{{ movie.poster_url }}" alt="{{ movie.title }}"
         style="width: 200px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);"
         onerror="this.style.display='none'"/>
    {% endif %}

    <div>
        <h1 style="margin: 0 0 10px 0;">{{ movie.title }}</h1>
        <p style="color: #999; margin: 0 0 20px 0;">{{ movie.year }}</p>
        <p style="color: #ccc;">Movie files in library</p>
    </div>
</div>

<div id="loading" style="display: block; text-align: center; padding: 40px;">
    <p>Loading movie files...</p>
</div>

<div id="files-list" style="display: none;"></div>

<div id="no-files" style="display: none;" class="empty-state">
    <h3>No files found</h3>
    <p>This movie has no downloaded files yet.</p>
</div>

<style>
.file-card {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.2s;
}

.file-card:hover {
    background: #252525;
}

.file-name {
    font-size: 16px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 10px;
}

.file-details {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 14px;
    color: #999;
}

.file-detail-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.file-detail-label {
    font-weight: bold;
    color: #4CAF50;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #888;
}

.empty-state h3 {
    margin-bottom: 10px;
}
</style>

<script>
const movieId = {{ movie_id }};

async function loadMovieFiles() {
    const loading = document.getElementById('loading');
    const filesList = document.getElementById('files-list');
    const noFiles = document.getElementById('no-files');

    try {
        const response = await fetch(`/api/library/movies/${movieId}/files`);
        const data = await response.json();

        loading.style.display = 'none';

        if (data.success && data.files && data.files.length > 0) {
            filesList.style.display = 'block';
            renderFiles(data.files);
        } else {
            noFiles.style.display = 'block';
        }
    } catch (error) {
        loading.style.display = 'none';
        // Check if endpoint doesn't exist (404), show placeholder message
        if (error.message.includes('404')) {
            filesList.innerHTML = '<div class="empty-state"><h3>Feature Coming Soon</h3><p>Movie file details will be available here.</p></div>';
            filesList.style.display = 'block';
        } else {
            alert(`Error loading movie files: ${error.message}`);
        }
    }
}

function renderFiles(files) {
    const filesList = document.getElementById('files-list');
    filesList.innerHTML = '';

    files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'file-card';

        const fileName = file.name || file.relativePath || 'Unknown';
        const quality = file.quality?.quality?.name || 'Unknown';
        const size = file.size ? formatBytes(file.size) : 'Unknown';
        const resolution = file.mediaInfo?.resolution || 'Unknown';
        const videoCodec = file.mediaInfo?.videoCodec || 'Unknown';
        const audioCodec = file.mediaInfo?.audioCodec || 'Unknown';

        card.innerHTML = `
            <div class="file-name">${fileName}</div>
            <div class="file-details">
                <div class="file-detail-item">
                    <span class="file-detail-label">Quality:</span>
                    <span>${quality}</span>
                </div>
                <div class="file-detail-item">
                    <span class="file-detail-label">Size:</span>
                    <span>${size}</span>
                </div>
                <div class="file-detail-item">
                    <span class="file-detail-label">Resolution:</span>
                    <span>${resolution}</span>
                </div>
                <div class="file-detail-item">
                    <span class="file-detail-label">Video:</span>
                    <span>${videoCodec}</span>
                </div>
                <div class="file-detail-item">
                    <span class="file-detail-label">Audio:</span>
                    <span>${audioCodec}</span>
                </div>
            </div>
        `;

        filesList.appendChild(card);
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Load movie files on page load
window.addEventListener('DOMContentLoaded', () => {
    loadMovieFiles();
});
</script>
{% endblock %}
